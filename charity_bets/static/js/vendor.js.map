{"version":3,"sources":["angular-payments.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"vendor.js","sourcesContent":["angular.module('angularPayments', []);angular.module('angularPayments')\n\n.factory('Common', [function(){\n\n  var ret = {};\n\n\n  // expiry is a string \"mm / yy[yy]\"\n  ret['parseExpiry'] = function(value){\n    var month, prefix, year, _ref;\n\n    value = value || ''\n\n    value = value.replace(/\\s/g, '');\n    _ref = value.split('/', 2), month = _ref[0], year = _ref[1];\n\n    if ((year != null ? year.length : void 0) === 2 && /^\\d+$/.test(year)) {\n      prefix = (new Date).getFullYear();\n      prefix = prefix.toString().slice(0, 2);\n      year = prefix + year;\n    }\n\n    month = parseInt(month, 10);\n    year = parseInt(year, 10);\n    \n    return {\n      month: month,\n      year: year\n    };\n  }\n\n  return ret;\n\n}]);angular.module('angularPayments')\n\n.factory('Cards', [function(){\n\n  var defaultFormat = /(\\d{1,4})/g;\n  var defaultInputFormat =  /(?:^|\\s)(\\d{4})$/;\n\n        var cards = [\n    {\n      type: 'maestro',\n      pattern: /^(5018|5020|5038|6304|6759|676[1-3])/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [12, 13, 14, 15, 16, 17, 18, 19],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'dinersclub',\n      pattern: /^(36|38|30[0-5])/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [14],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'laser',\n      pattern: /^(6706|6771|6709)/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [16, 17, 18, 19],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'jcb',\n      pattern: /^35/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [16],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'unionpay',\n      pattern: /^62/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [16, 17, 18, 19],\n      cvcLength: [3],\n      luhn: false\n    }, {\n      type: 'discover',\n      pattern: /^(6011|65|64[4-9]|622)/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [16],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'mastercard',\n      pattern: /^5[1-5]/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [16],\n      cvcLength: [3],\n      luhn: true\n    }, {\n      type: 'amex',\n      pattern: /^3[47]/,\n      format: /(\\d{1,4})(\\d{1,6})?(\\d{1,5})?/,\n      inputFormat: /^(\\d{4}|\\d{4}\\s\\d{6})$/,\n      length: [15],\n      cvcLength: [3, 4],\n      luhn: true\n    }, {\n      type: 'visa',\n      pattern: /^4/,\n      format: defaultFormat,\n      inputFormat: defaultInputFormat,\n      length: [13, 14, 15, 16],\n      cvcLength: [3],\n      luhn: true\n    }\n  ];\n\n\n  var _fromNumber = function(num){\n      var card, i, len;\n\n      num = (num + '').replace(/\\D/g, '');\n\n      for (i = 0, len = cards.length; i < len; i++) {\n\n        card = cards[i];\n\n        if (card.pattern.test(num)) {\n          return card;\n        }\n\n      }\n  }\n\n  var _fromType = function(type) {\n      var card, i, len;\n\n      for (i = 0, len = cards.length; i < len; i++) {\n\n        card = cards[i];\n        \n        if (card.type === type) {\n          return card;\n        }\n\n      }\n  };\n\n  return {\n      fromNumber: function(val) { return _fromNumber(val) },\n      fromType: function(val) { return _fromType(val) },\n      defaultFormat: function() { return defaultFormat;},\n      defaultInputFormat: function() { return defaultInputFormat;}\n  }\n\n}]);angular.module('angularPayments')\n\n\n.factory('_Format',['Cards', 'Common', '$filter', function(Cards, Common, $filter){\n\n  var _formats = {}\n\n  var _hasTextSelected = function($target) {\n      var ref;\n      \n      if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== $target.prop('selectionEnd')) {\n          return true;\n      }\n      \n      if (typeof document !== \"undefined\" && document !== null ? (ref = document.selection) != null ? typeof ref.createRange === \"function\" ? ref.createRange().text : void 0 : void 0 : void 0) {\n          return true;\n      }\n      \n      return false;\n    };\n\n  // card formatting\n\n  var _formatCardNumber = function(e) {\n      var $target, card, digit, length, re, upperLength, value;\n      \n      digit = String.fromCharCode(e.which);\n      $target = angular.element(e.currentTarget);\n      value = $target.val();\n      card = Cards.fromNumber(value + digit);\n      length = (value.replace(/\\D/g, '') + digit).length;\n      \n      upperLength = 16;\n      \n      if (card) {\n        upperLength = card.length[card.length.length - 1];\n      }\n      \n      if (length >= upperLength) {\n        return;\n      }\n\n      if (!/^\\d+$/.test(digit) && !e.meta && e.keyCode >= 46) {\n        e.preventDefault();\n        return;\n      }\n\n      if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {\n        return;\n      }\n\n      re = Cards.defaultInputFormat();\n      if (card) {\n          re = card.inputFormat;\n      }\n\n      if (re.test(value)) {\n        e.preventDefault();\n        return $target.val(value + ' ' + digit);\n\n      } else if (re.test(value + digit)) {\n        e.preventDefault();\n        return $target.val(value + digit + ' ');\n\n      }\n  };\n\n  var _restrictCardNumber = function(e) {\n      var $target, card, digit, value;\n      \n      $target = angular.element(e.currentTarget);\n      digit = String.fromCharCode(e.which);\n      \n      if(!/^\\d+$/.test(digit)) {\n        return;\n      }\n      \n      if(_hasTextSelected($target)) {\n        return;\n      }\n      \n      value = ($target.val() + digit).replace(/\\D/g, '');\n      card = Cards.fromNumber(value);\n      \n      if(card) {\n        if(!(value.length <= card.length[card.length.length - 1])){\n          e.preventDefault();\n        }\n      } else {\n        if(!(value.length <= 16)){\n          e.preventDefault();\n        }\n      }\n  };\n\n  var _formatBackCardNumber = function(e) {\n      var $target, value;\n      \n      $target = angular.element(e.currentTarget);\n      value = $target.val();\n      \n      if(e.meta) {\n        return;\n      }\n      \n      if(e.which !== 8) {\n        return;\n      }\n      \n      if(($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {\n        return;\n      }\n      \n      if(/\\d\\s$/.test(value) && !e.meta && e.keyCode >= 46) {\n        e.preventDefault();\n        return $target.val(value.replace(/\\d\\s$/, ''));\n      } else if (/\\s\\d?$/.test(value)) {\n        e.preventDefault();\n        return $target.val(value.replace(/\\s\\d?$/, ''));\n      }\n    };\n\n  var _getFormattedCardNumber = function(num) {\n      var card, groups, upperLength, ref;\n      \n      card = Cards.fromNumber(num);\n      \n      if (!card) {\n        return num;\n      }\n      \n      upperLength = card.length[card.length.length - 1];\n      num = num.replace(/\\D/g, '');\n      num = num.slice(0, +upperLength + 1 || 9e9);\n      \n      if(card.format.global) {\n        return (ref = num.match(card.format)) != null ? ref.join(' ') : void 0;\n      } else {\n        groups = card.format.exec(num);\n          \n        if (groups != null) {\n          groups.shift();\n        }\n\n        return groups != null ? groups.join(' ') : void 0;\n      }\n    };\n\n  var _reFormatCardNumber = function(e) {\n    return setTimeout(function() {\n      var $target, value;\n      $target = angular.element(e.target);\n    \n      value = $target.val();\n      value = _getFormattedCardNumber(value);\n      return $target.val(value);\n    });\n  };\n\n  var _parseCardNumber = function(value) {\n    return value != null ? value.replace(/\\s/g, '') : value;\n  };\n\n  _formats['card'] = function(elem, ctrl){\n    elem.bind('keypress', _restrictCardNumber);\n    elem.bind('keypress', _formatCardNumber);\n    elem.bind('keydown', _formatBackCardNumber);\n    elem.bind('paste', _reFormatCardNumber);\n\n    ctrl.$parsers.push(_parseCardNumber);\n    ctrl.$formatters.push(_getFormattedCardNumber);\n  }\n\n\n  // cvc\n\n  _formatCVC = function(e){\n    $target = angular.element(e.currentTarget);\n    digit = String.fromCharCode(e.which);\n    \n    if (!/^\\d+$/.test(digit) && !e.meta && e.keyCode >= 46) {\n      e.preventDefault();\n      return;\n    }\n\n    val = $target.val() + digit;\n    \n    if(val.length <= 4){\n      return;\n    } else {\n      e.preventDefault();\n      return;\n    }\n  }\n\n  _formats['cvc'] = function(elem){\n    elem.bind('keypress', _formatCVC)\n  }\n\n  // expiry\n\n  _restrictExpiry = function(e) {\n    var $target, digit, value;\n    \n    $target = angular.element(e.currentTarget);\n    digit = String.fromCharCode(e.which);\n    \n    if (!/^\\d+$/.test(digit) && !e.meta && e.keyCode >= 46) {\n      e.preventDefault();\n      return;\n    }\n    \n    if(_hasTextSelected($target)) {\n      return;\n    }\n    \n    value = $target.val() + digit;\n    value = value.replace(/\\D/g, '');\n    \n    if (value.length > 6) {\n      e.preventDefault()\n      return;\n    }\n  };\n\n  _formatExpiry = function(e) {\n    var $target, digit, val;\n    \n    digit = String.fromCharCode(e.which);\n    \n    if (!/^\\d+$/.test(digit) && !e.meta && e.keyCode >= 46) {\n      e.preventDefault();\n      return;\n    }\n    \n    $target = angular.element(e.currentTarget);\n    val = $target.val() + digit;\n    \n    if (/^\\d$/.test(val) && (val !== '0' && val !== '1')) {\n      e.preventDefault();\n      return $target.val(\"0\" + val + \" / \");\n\n    } else if (/^\\d\\d$/.test(val)) {\n      e.preventDefault();\n      return $target.val(\"\" + val + \" / \");\n\n    }\n  };\n\n  _formatForwardExpiry = function(e) {\n    var $target, digit, val;\n    \n    digit = String.fromCharCode(e.which);\n    \n    if (!/^\\d+$/.test(digit) && !e.meta && e.keyCode >= 46) {\n      return;\n    }\n    \n    $target = angular.element(e.currentTarget);\n    val = $target.val();\n    \n    if (/^\\d\\d$/.test(val)) {\n      return $target.val(\"\" + val + \" / \");\n    }\n  };\n\n  _formatForwardSlash = function(e) {\n    var $target, slash, val;\n    \n    slash = String.fromCharCode(e.which);\n    \n    if (slash !== '/') {\n      return;\n    }\n    \n    $target = angular.element(e.currentTarget);\n    val = $target.val();\n    \n    if (/^\\d$/.test(val) && val !== '0') {\n      return $target.val(\"0\" + val + \" / \");\n    }\n  };\n\n  _formatBackExpiry = function(e) {\n    var $target, value;\n    \n    if (e.meta) {\n      return;\n    }\n    \n    $target = angular.element(e.currentTarget);\n    value = $target.val();\n    \n    if (e.which !== 8) {\n      return;\n    }\n    \n    if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {\n      return;\n    }\n    \n    if (/\\d(\\s|\\/)+$/.test(value)) {\n      e.preventDefault();\n      return $target.val(value.replace(/\\d(\\s|\\/)*$/, ''));\n\n    } else if (/\\s\\/\\s?\\d?$/.test(value)) {\n      e.preventDefault();\n      return $target.val(value.replace(/\\s\\/\\s?\\d?$/, ''));\n\n    }\n  };\n\n  var _parseExpiry = function(value) {\n    if(value != null) {\n      var obj = Common.parseExpiry(value);\n      var expiry = new Date(obj.year, obj.month-1);\n      return $filter('date')(expiry, 'MM/yyyy');\n    }\n    return null;\n  };\n\n  var _getFormattedExpiry = function(value) {\n    if(value != null) {\n      var obj = Common.parseExpiry(value);\n      var expiry = new Date(obj.year, obj.month-1);\n      return $filter('date')(expiry, 'MM / yyyy');\n    }\n    return null;\n  };\n\n\n  _formats['expiry'] = function(elem, ctrl){\n    elem.bind('keypress', _restrictExpiry);\n    elem.bind('keypress', _formatExpiry);\n    elem.bind('keypress', _formatForwardSlash);\n    elem.bind('keypress', _formatForwardExpiry);\n    elem.bind('keydown', _formatBackExpiry);\n\n    ctrl.$parsers.push(_parseExpiry);\n    ctrl.$formatters.push(_getFormattedExpiry);\n  }\n\n  return function(type, elem, ctrl){\n    if(!_formats[type]){\n\n      types = Object.keys(_formats);\n\n      errstr  = 'Unknown type for formatting: \"'+type+'\". ';\n      errstr += 'Should be one of: \"'+types.join('\", \"')+'\"';\n\n      throw errstr;\n    }\n    return _formats[type](elem, ctrl);\n  }\n\n}])\n\n.directive('paymentsFormat', ['$window', '_Format', function($window, _Format){\n    return {\n      restrict: 'A',\n      require: 'ngModel',\n      link: function(scope, elem, attr, ctrl){\n        _Format(attr.paymentsFormat, elem, ctrl);\n      }\n    }\n}]);angular.module('angularPayments')\n\n\n\n.factory('_Validate', ['Cards', 'Common', '$parse', function(Cards, Common, $parse){\n\n  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }\n\n  var _luhnCheck = function(num) {\n    var digit, digits, odd, sum, i, len;\n\n    odd = true;\n    sum = 0;\n    digits = (num + '').split('').reverse();\n\n    for (i = 0, len = digits.length; i < len; i++) {\n\n      digit = digits[i];\n      digit = parseInt(digit, 10);\n\n      if ((odd = !odd)) {\n        digit *= 2;\n      }\n\n      if (digit > 9) {\n        digit -= 9;\n      }\n\n      sum += digit;\n\n    }\n\n    return sum % 10 === 0;\n  };\n\n  var _validators = {}\n\n  _validators['cvc'] = function(cvc, ctrl, scope, attr){\n      var ref, ref1;\n\n      // valid if empty - let ng-required handle empty\n      if(cvc == null || cvc.length == 0) return true;\n\n      if (!/^\\d+$/.test(cvc)) {\n        return false;\n      }\n\n      var type;\n      if(attr.paymentsTypeModel) {\n          var typeModel = $parse(attr.paymentsTypeModel);\n          type = typeModel(scope);\n      }\n\n      if (type) {\n        return ref = cvc.length, __indexOf.call((ref1 = Cards.fromType(type)) != null ? ref1.cvcLength : void 0, ref) >= 0;\n      } else {\n        return cvc.length >= 3 && cvc.length <= 4;\n      }\n  }\n\n  _validators['card'] = function(num, ctrl, scope, attr){\n      var card, ref, typeModel;\n\n      if(attr.paymentsTypeModel) {\n          typeModel = $parse(attr.paymentsTypeModel);\n      }\n\n      var clearCard = function(){\n          if(typeModel) {\n              typeModel.assign(scope, null);\n          }\n          ctrl.$card = null;\n      };\n\n      // valid if empty - let ng-required handle empty\n      if(num == null || num.length == 0){\n        clearCard();\n        return true;\n      }\n\n      num = (num + '').replace(/\\s+|-/g, '');\n\n      if (!/^\\d+$/.test(num)) {\n        clearCard();\n        return false;\n      }\n\n      card = Cards.fromNumber(num);\n\n      if(!card) {\n        clearCard();\n        return false;\n      }\n\n      ctrl.$card = angular.copy(card);\n\n      if(typeModel) {\n          typeModel.assign(scope, card.type);\n      }\n\n      ret = (ref = num.length, __indexOf.call(card.length, ref) >= 0) && (card.luhn === false || _luhnCheck(num));\n\n      return ret;\n  }\n\n  _validators['expiry'] = function(val){\n    // valid if empty - let ng-required handle empty\n    if(val == null || val.length == 0) return true;\n\n    obj = Common.parseExpiry(val);\n\n    month = obj.month;\n    year = obj.year;\n\n    var currentTime, expiry, prefix;\n\n    if (!(month && year)) {\n      return false;\n    }\n\n    if (!/^\\d+$/.test(month)) {\n      return false;\n    }\n\n    if (!/^\\d+$/.test(year)) {\n      return false;\n    }\n\n    if (!(parseInt(month, 10) <= 12)) {\n      return false;\n    }\n\n    if (year.length === 2) {\n      prefix = (new Date).getFullYear();\n      prefix = prefix.toString().slice(0, 2);\n      year = prefix + year;\n    }\n\n    expiry = new Date(year, month);\n    currentTime = new Date;\n    expiry.setMonth(expiry.getMonth() - 1);\n    expiry.setMonth(expiry.getMonth() + 1, 1);\n\n    return expiry > currentTime;\n  }\n\n  return function(type, val, ctrl, scope, attr){\n    if(!_validators[type]){\n\n      types = Object.keys(_validators);\n\n      errstr  = 'Unknown type for validation: \"'+type+'\". ';\n      errstr += 'Should be one of: \"'+types.join('\", \"')+'\"';\n\n      throw errstr;\n    }\n    return _validators[type](val, ctrl, scope, attr);\n  }\n}])\n\n\n.factory('_ValidateWatch', ['_Validate', function(_Validate){\n\n    var _validatorWatches = {}\n\n    _validatorWatches['cvc'] = function(type, ctrl, scope, attr){\n        if(attr.paymentsTypeModel) {\n            scope.$watch(attr.paymentsTypeModel, function(newVal, oldVal) {\n                if(newVal != oldVal) {\n                    var valid = _Validate(type, ctrl.$modelValue, ctrl, scope, attr);\n                    ctrl.$setValidity(type, valid);\n                }\n            });\n        }\n    }\n\n    return function(type, ctrl, scope, attr){\n        if(_validatorWatches[type]){\n            return _validatorWatches[type](type, ctrl, scope, attr);\n        }\n    }\n}])\n\n.directive('paymentsValidate', ['$window', '_Validate', '_ValidateWatch', function($window, _Validate, _ValidateWatch){\n  return {\n    restrict: 'A',\n    require: 'ngModel',\n    link: function(scope, elem, attr, ctrl){\n\n      var type = attr.paymentsValidate;\n\n      _ValidateWatch(type, ctrl, scope, attr);\n\n      var validateFn = function(val) {\n          var valid = _Validate(type, val, ctrl, scope, attr);\n          ctrl.$setValidity(type, valid);\n          return valid ? val : undefined;\n      };\n\n      ctrl.$formatters.push(validateFn);\n      ctrl.$parsers.push(validateFn);\n    }\n  }\n}])\n;angular.module('angularPayments')\n\n.directive('stripeForm', ['$window', '$parse', 'Common', function($window, $parse, Common) {\n    \n  // directive intercepts form-submission, obtains Stripe's cardToken using stripe.js\n  // and then passes that to callback provided in stripeForm, attribute.\n\n  // data that is sent to stripe is filtered from scope, looking for valid values to\n  // send and converting camelCase to snake_case, e.g expMonth -> exp_month\n\n\n  // filter valid stripe-values from scope and convert them from camelCase to snake_case\n  _getDataToSend = function(data){\n           \n    var possibleKeys = ['number', 'expMonth', 'expYear', \n                    'cvc', 'name','addressLine1', \n                    'addressLine2', 'addressCity',\n                    'addressState', 'addressZip',\n                    'addressCountry']\n    \n    var camelToSnake = function(str){\n      return str.replace(/([A-Z])/g, function(m){\n        return \"_\"+m.toLowerCase();\n      });\n    }\n\n    var ret = {};\n\n    for(i in possibleKeys){\n        if(data.hasOwnProperty(possibleKeys[i])){\n            ret[camelToSnake(possibleKeys[i])] = angular.copy(data[possibleKeys[i]]);\n        }\n    }\n\n    ret['number'] = (ret['number'] || '').replace(/ /g,'');\n\n    return ret;\n  }\n\n  return {\n    restrict: 'A',\n    link: function(scope, elem, attr) {\n\n      if(!$window.Stripe){\n          throw 'stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.';\n      }\n\n      var form = angular.element(elem);\n\n      form.bind('submit', function() {\n\n        expMonthUsed = scope.expMonth ? true : false;\n        expYearUsed = scope.expYear ? true : false;\n\n        if(!(expMonthUsed && expYearUsed)){\n          exp = Common.parseExpiry(scope.expiry)\n          scope.expMonth = exp.month\n          scope.expYear = exp.year\n        }\n\n        var button = form.find('button');\n        button.prop('disabled', true);\n\n        if(form.hasClass('ng-valid')) {\n          \n\n          $window.Stripe.createToken(_getDataToSend(scope), function() {\n            var args = arguments;\n            scope.$apply(function() {\n              scope[attr.stripeForm].apply(scope, args);\n            });\n            button.prop('disabled', false);\n\n          });\n\n        } else {\n          scope.$apply(function() {\n            scope[attr.stripeForm].apply(scope, [400, {error: 'Invalid form submitted.'}]);\n          });\n          button.prop('disabled', false);\n        }\n\n        scope.expMonth = null;\n        scope.expYear  = null;\n\n      });\n    }\n  }\n}]);\n"],"sourceRoot":"/source/"}